#!/bin/bash

set -e

[ "$DEBUG" = "true" ] && set -x

echo "Running \"deploy\" hook."

run-hooks deploy

if [[ "$MAGENTO_RUN_MODE" == "production" ]] ; then
    minor_magento_version=$(magento-command --version | sed "s/Magento CLI \([0-9]*\.[0-9]*\).*/\1/")
    if [[ "$minor_magento_version" != "2.1" ]]; then
        echo "Setting Varnish for FPC."
        output=$(magento-command config:set system/full_page_cache/caching_application 2)
        if [[ $? != 0 ]] ; then
            echo "Notice: Varnish was not set as caching application of FPC"
            echo $output
        else
            magento-command setup:config:set --http-cache-hosts=varnish
        fi
    fi
fi

echo "Deployment finished."
